#RabbitJump

##Основные источники*
1. [RabbitMQ Tutorial](https://www.rabbitmq.com/getstarted.html)
1. [php-amqplib](https://github.com/php-amqplib/php-amqplib)
1. [Reliable messaging with RabbitMQ (video)](https://www.youtube.com/watch?v=XjuiZM7JzPw)

\* - основные.

##Установка
Следуем инструкциям `https://www.rabbitmq.com/download.html` для своей системы.
Не забываем установить ulimit (если это Linux и есть такая необходимость).
Порт RabbitMQ по умолчанию `5672`, порт UI-консоли `15672`.

###Ниже краткая инструкция для Debian / Ubuntu:

Устанавливаем из репозитория:

`sudo aptitude install rabbitmq-server`

Включаем RabbitMQ UI:

`sudo rabbitmq-plugins enable rabbitmq_management`

Заходим на `http://localhost:15672/`

В свежей установке логин/пароль: `guest:guest`

Проверяем количество доступных дескрипторов файлов.

Если есть необходимость, конфигурируем `ulimit` системный и для пользователя `rabbitmq`.

###Дополнительно
Для использования RabbitMQ в своём проекте необходимо подключить какой-нибудь пакет для общения по протоколу `AMQP`.
Например, `php-amqplib/php-amqplib` (`composer require php-amqplib/php-amqplib`).

#Задание 1. Простейшее однократное взаимодействие.
Знакомимся с RabbitMQ.

1. Подключиться к RabbitMQ
1. Отправить одно сообщение в очередь 'hello'
1. Принять одно сообщение из очереди 'hello'

Для реализации потребуется:

1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Отправить сообщение в очередь.
1. Закрыть канал и соединение.
1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Прочитать одно сообщение из очереди.
1. Отправить подтверждение о том, что сообщение прочитано.
1. Закрыть канал и соединение.

В примере для общения с RabbitMQ используется `AMQPStreamConnection`. При однократной отправке и получении сообщений в потоке нет необходимости.

Для запуска примера:
1. `cd cli`
1. `php index.php -c producer`
1. `php index.php -c consumer`

При желании можно воспользоваться командой `php index.php -c producer -p "m=MESSAGE"` для отправки своего сообщения.

См. классы `ConsumerCommand`, `ProducerCommand`. 


#Задание 2. Потоки сообщений.
Знакомимся с возможностями обработки сообщений и буферизации.

1. Подключиться к RabbitMQ
1. Запустить поток сообщений в очередь 'hello'
1. Запустить поток приёма сообщений из очереди 'hello'

Для реализации потребуется:

1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Отправлять сообщения в очередь в цикле.
1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Начать цикл получения сообщений из очереди.

В примере для общения с RabbitMQ используется `AMQPStreamConnection`.

Для запуска примера:
1. `cd cli`
1. В одной консоли: `php index.php -c generating_producer`
1. В другой консоли: `php index.php -c waiting_consumer`

При желании можно воспользоваться параметрами:

 `php index.php -c generating_producer -p "m=MESSAGE" -p delay=2` 
 для отправки своего сообщения и установки времени задержки между сообщениями (по умолчанию 1 секунда).

 `php index.php -c waiting_consumer -p delay=2` 
 для отправки своего сообщения и установки времени задержки между приёмом сообщений (по умолчанию нет).

См. классы `WaitingConsumerCommand`, `GeneratingProducerCommand`. 


#Задание 3. Эмуляция СМО с задержкой при обработке сообщений.
Эмулируем систему с несколькими генераторами сообщений, несколькими обработчиками и разной скоростью обработки сообщений.

1. Подключиться к RabbitMQ
1. Запустить несколько потоков сообщений в очередь 'hello'
1. Запустить потоков приёма сообщений из очереди 'hello'

Для реализации потребуется:

1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Отправлять сообщения в очередь в цикле.
1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Начать цикл получения сообщений из очереди.
1. Повторить пп. 1-8 несколько раз. 

В примере для общения с RabbitMQ используется `AMQPStreamConnection`.

Для запуска примера:
1. `cd cli`
1. В нескольких консолях: `php index.php -c generating_producer -p rd=true`
1. В нескольких консолях: `php index.php -c waiting_consumer`

Пронаблюдать за логами. Установить равновесие между генераторами и обработчиками.
Обратить внимание на web-консоль: в ней сообщения не накапливаются в очереди.

См. классы `WaitingConsumerCommand`, `GeneratingProducerCommand`. 

#Задание 4. Подверждение о получении.

До этого момента мы имели део со случаем, когда подтверждение о получении сообщения приходит сразу после получения его потребителем вне зависимости от скорости обработки сообщения.

Попробуем сделать подтверждение сообщений после обработки.

1. Подключиться к RabbitMQ
1. Запустить несколько потоков сообщений в очередь 'hello'
1. Запустить потоков приёма сообщений из очереди 'hello'

Для реализации потребуется:

1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Отправлять сообщения в очередь в цикле.
1. Открыть соединение с RabbitMQ, используя параметры host, port, user, password.
1. Открыть канал подключения. 
1. Подключиться к очереди 'hello' в RabbitMQ (при отсутствии создать её).
1. Начать цикл получения сообщений из очереди с подтверждением после обработки.
1. Повторить пп. 1-8 несколько раз. 

В примере для общения с RabbitMQ используется `AMQPStreamConnection`.

Для запуска примера:
1. `cd cli`
1. В нескольких консолях: `php index.php -c generating_producer -p rd=true`
1. В нескольких консолях: `php index.php -c ack_consumer`

Пронаблюдать за логами. Установить равновесие между генераторами и обработчиками.
Обратить внимание на web-консоль: в ней накапливается некоторое количество неподтверждённых сообщений.

Накопить неподтвержённые сообщения. Закрыть генераторы. 
Закрыть один из потоков-обработчиков. 
Открыть новый, закрыть остальные. 
Убедиться, что в новый поток пришли сообщения, оставшиеся необработанными.

См. классы `AckConsumerCommand`, `GeneratingProducerCommand`. 

#Задание 5. Durable. 